<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>ê³ ê°€ì¹˜ ì‚¬ìš©ì ì¢…í•© ë¶„ì„ ë³´ê³ ì„œ</title>
    <style>
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f8f9fa;
        }
        
        header {
            background-color: #2c3e50;
            color: white;
            padding: 20px;
            text-align: center;
            border-radius: 8px;
            margin-bottom: 30px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        h1, h2, h3 {
            color: #2c3e50;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background-color: #fff;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #e1e1e1;
        }
        
        th {
            background-color: #f1f8ff;
            font-weight: 600;
            color: #2c3e50;
            cursor: pointer;
        }
        
        th:hover {
            background-color: #e1effe;
        }
        
        tbody tr:hover {
            background-color: #f9f9f9;
        }
        
        .section {
            background-color: #fff;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .summary-stats {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            margin: 20px 0;
        }
        
        .stat-card {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            width: calc(33.33% - 15px);
            box-sizing: border-box;
        }
        
        .stat-value {
            font-size: 1.8em;
            font-weight: 700;
            color: #3498db;
            margin: 10px 0;
        }
        
        .stat-sub {
            color: #7f8c8d;
            font-size: 0.9em;
        }
        
        .comparison-table {
            width: 100%;
        }
        
        .tag {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.85em;
        }
        
        .tag-active {
            background-color: rgba(40, 167, 69, 0.1);
            color: #28a745;
            border: 1px solid rgba(40, 167, 69, 0.2);
        }
        
        .tag-dormant {
            background-color: rgba(220, 53, 69, 0.1);
            color: #dc3545;
            border: 1px solid rgba(220, 53, 69, 0.2);
        }
        
        .bar-chart {
            margin-top: 20px;
        }
        
        .bar-chart .chart-bar {
            height: 25px;
            margin-bottom: 8px;
            background-color: #3498db;
            border-radius: 4px;
            transition: width 0.5s ease;
            position: relative;
        }
        
        .bar-chart .chart-label {
            width: 120px;
            display: inline-block;
            margin-right: 10px;
            text-align: right;
            font-weight: 500;
        }
        
        .bar-chart .chart-value {
            position: absolute;
            right: 10px;
            color: white;
            font-weight: 500;
        }
        
        .recommendations {
            background-color: #f0f9ff;
            border-left: 4px solid #28a745;
            padding: 15px;
            margin: 20px 0;
            border-radius: 0 4px 4px 0;
        }
        
        .recommendations h3 {
            margin-top: 0;
            color: #28a745;
        }
        
        /* ìƒˆë¡œ ì¶”ê°€ëœ ìŠ¤íƒ€ì¼ */
        .filter-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        
        .filter-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .filter-group label {
            font-weight: 500;
            color: #495057;
        }
        
        .filter-group select,
        .filter-group input {
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .btn {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        
        .btn:hover {
            background-color: #2980b9;
        }
        
        .btn:disabled {
            background-color: #b3b3b3;
            cursor: not-allowed;
        }
        
        .loading-indicator {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 0;
        }
        
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error-message {
            background-color: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: center;
        }
        
        .pagination-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
            background-color: #f8f9fa;
            padding: 10px 15px;
            border-radius: 8px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        
        .pagination-controls {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .pagination-btn {
            background-color: white;
            border: 1px solid #dee2e6;
            color: #3498db;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .pagination-btn:hover:not(:disabled) {
            background-color: #3498db;
            color: white;
            border-color: #3498db;
        }
        
        .pagination-btn:disabled {
            color: #b3b3b3;
            cursor: not-allowed;
        }
        
        .pagination-btn.active {
            background-color: #3498db;
            color: white;
            border-color: #3498db;
        }
        
        .page-numbers {
            display: flex;
            gap: 5px;
        }
        
        .page-size-selector {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .page-size-selector select {
            padding: 6px 10px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
        }

        .api-version-badge {
            background-color: #17a2b8;
            color: white;
            font-size: 0.75rem;
            padding: 3px 6px;
            border-radius: 4px;
            margin-left: 8px;
            display: inline-block;
            vertical-align: middle;
        }

        .criteria-info {
            background-color: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 15px;
            margin: 15px 0;
            border-radius: 0 4px 4px 0;
        }

        .criteria-info h4 {
            margin-top: 0;
            color: #1976d2;
        }
    </style>
</head>
<body>
    <header>
        <h1>ê³ ê°€ì¹˜ ì‚¬ìš©ì ì¢…í•© ë¶„ì„ ë³´ê³ ì„œ <span class="api-version-badge">v3.0</span></h1>
        <p>7ì¼ ì´ìƒ ê²Œì„ ê¸°ë¡ ë° ìœ íš¨ë°°íŒ… 50,000 ì´ìƒ ì‚¬ìš©ì ë¶„ì„</p>
        <p>ë¶„ì„ì¼: <span id="analysisDate">2025-05-22</span></p>
    </header>
    
    <div class="section">
        <h2>ë¶„ì„ ê°œìš”</h2>
        
        <div class="criteria-info">
            <h4>ğŸ“Š í™œì„±/íœ´ë©´ ê¸°ì¤€</h4>
            <ul>
                <li><strong>í™œì„± ì‚¬ìš©ì</strong>: ìµœê·¼ 30ì¼ ì´ë‚´ì— ê²Œì„ ê¸°ë¡ì´ ìˆëŠ” ì‚¬ìš©ì</li>
                <li><strong>íœ´ë©´ ì‚¬ìš©ì</strong>: 30ì¼ ì´ìƒ ê²Œì„ ê¸°ë¡ì´ ì—†ëŠ” ì‚¬ìš©ì</li>
            </ul>
        </div>

        <p>ë³¸ ë³´ê³ ì„œëŠ” ë‹¤ìŒ ì¡°ê±´ì„ ë§Œì¡±í•˜ëŠ” ê³ ê°€ì¹˜ ì‚¬ìš©ìì— ëŒ€í•œ ë¶„ì„ ê²°ê³¼ì…ë‹ˆë‹¤:</p>
        <ul>
            <li>7ì¼ ì´ìƒ ê²Œì„ ê¸°ë¡ì´ ìˆëŠ” ì‚¬ìš©ì</li>
            <li>ì „ì²´ ìœ íš¨ë°°íŒ…(netBet)ì˜ í•©ì´ 50,000 ì´ìƒì¸ ì‚¬ìš©ì</li>
        </ul>
        
        <div class="summary-stats">
            <div class="stat-card">
                <h3>ì´ ê³ ê°€ì¹˜ ì‚¬ìš©ì ìˆ˜</h3>
                <div class="stat-value" id="totalUsers">-</div>
                <div class="stat-sub">ëª¨ë“  í™œì„± ë° íœ´ë©´ ì‚¬ìš©ì</div>
            </div>
            <div class="stat-card">
                <h3>í™œì„± ì‚¬ìš©ì ìˆ˜</h3>
                <div class="stat-value" id="activeUsers">-</div>
                <div class="stat-sub">ìµœê·¼ 30ì¼ ë‚´ í™œë™</div>
            </div>
            <div class="stat-card">
                <h3>íœ´ë©´ ì‚¬ìš©ì ìˆ˜</h3>
                <div class="stat-value" id="dormantUsers">-</div>
                <div class="stat-sub">30ì¼ ì´ìƒ ë¯¸í™œë™</div>
            </div>
        </div>
    </div>
    
    <!-- ì‚¬ìš©ì ë¹„êµ ë¶„ì„ ì„¹ì…˜ -->
    <div class="section">
        <h2>í™œì„± vs íœ´ë©´ ì‚¬ìš©ì ë¹„êµ</h2>
        <table class="comparison-table">
            <thead>
                <tr>
                    <th>ì§€í‘œ</th>
                    <th>í™œì„± ì‚¬ìš©ì</th>
                    <th>íœ´ë©´ ì‚¬ìš©ì</th>
                    <th>ì°¨ì´</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>í‰ê·  í”Œë ˆì´ ì¼ìˆ˜</td>
                    <td>15ì¼</td>
                    <td>9ì¼</td>
                    <td>+67%</td>
                </tr>
                <tr>
                    <td>í‰ê·  ìœ íš¨ë°°íŒ… ê¸ˆì•¡</td>
                    <td>185,420ì›</td>
                    <td>124,350ì›</td>
                    <td>+49%</td>
                </tr>
                <tr>
                    <td>ìµœëŒ€ ìœ íš¨ë°°íŒ… ê¸ˆì•¡</td>
                    <td>1,254,800ì›</td>
                    <td>845,600ì›</td>
                    <td>+48%</td>
                </tr>
            </tbody>
        </table>
    </div>
    
    <!-- íœ´ë©´ ì‚¬ìš©ì ë¶„ì„ ì„¹ì…˜ -->
    <div class="section">
        <h2>íœ´ë©´ ê¸°ê°„ë³„ ì‚¬ìš©ì ë¶„í¬</h2>
        <table>
            <thead>
                <tr>
                    <th>íœ´ë©´ ê¸°ê°„</th>
                    <th>ì‚¬ìš©ì ìˆ˜</th>
                    <th>ë¹„ìœ¨</th>
                    <th>í‰ê·  ìœ íš¨ë°°íŒ…</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>31-60ì¼</td>
                    <td>98ëª…</td>
                    <td>35.8%</td>
                    <td>142,350ì›</td>
                </tr>
                <tr>
                    <td>61-90ì¼</td>
                    <td>72ëª…</td>
                    <td>26.3%</td>
                    <td>128,650ì›</td>
                </tr>
                <tr>
                    <td>91-180ì¼</td>
                    <td>58ëª…</td>
                    <td>21.2%</td>
                    <td>105,320ì›</td>
                </tr>
                <tr>
                    <td>181-365ì¼</td>
                    <td>32ëª…</td>
                    <td>11.7%</td>
                    <td>86,450ì›</td>
                </tr>
                <tr>
                    <td>365ì¼ ì´ìƒ</td>
                    <td>14ëª…</td>
                    <td>5.0%</td>
                    <td>72,250ì›</td>
                </tr>
            </tbody>
        </table>
        
        <div class="bar-chart">
            <div>
                <span class="chart-label">31-60ì¼</span>
                <span class="chart-bar" style="width: 179px;">
                    <span class="chart-value">98ëª… (35.8%)</span>
                </span>
            </div>
            <div>
                <span class="chart-label">61-90ì¼</span>
                <span class="chart-bar" style="width: 131px;">
                    <span class="chart-value">72ëª… (26.3%)</span>
                </span>
            </div>
            <div>
                <span class="chart-label">91-180ì¼</span>
                <span class="chart-bar" style="width: 106px;">
                    <span class="chart-value">58ëª… (21.2%)</span>
                </span>
            </div>
            <div>
                <span class="chart-label">181-365ì¼</span>
                <span class="chart-bar" style="width: 58px;">
                    <span class="chart-value">32ëª… (11.7%)</span>
                </span>
            </div>
            <div>
                <span class="chart-label">365ì¼ ì´ìƒ</span>
                <span class="chart-bar" style="width: 25px;">
                    <span class="chart-value">14ëª… (5.0%)</span>
                </span>
            </div>
        </div>
    </div>
    
    <!-- ì‚¬ìš©ì ëª©ë¡ ì„¹ì…˜ -->
    <div class="section">
        <h2>ê³ ê°€ì¹˜ ì‚¬ìš©ì ëª©ë¡</h2>
        
        <div class="filter-controls">
            <div class="filter-group">
                <label for="userStatus">ìƒíƒœ:</label>
                <select id="userStatus">
                    <option value="all">ëª¨ë‘</option>
                    <option value="active">í™œì„±</option>
                    <option value="dormant">íœ´ë©´</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="minBetting">ìµœì†Œ ë² íŒ…ì•¡:</label>
                <input type="number" id="minBetting" value="50000" min="0" step="10000">
            </div>
            <div class="filter-group">
                <label for="userSearch">ê²€ìƒ‰:</label>
                <input type="text" id="userSearch" placeholder="ìœ ì €ëª… ê²€ìƒ‰...">
            </div>
            <button id="applyFilters" class="btn">í•„í„° ì ìš©</button>
            <button id="exportCsv" class="btn" style="margin-left: 10px; background-color: #28a745;">CSV ë‚´ë³´ë‚´ê¸°</button>
        </div>
        
        <div id="loadingIndicator" class="loading-indicator">
            <div class="spinner"></div>
            <p>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
        </div>
        
        <div id="errorMessage" class="error-message" style="display: none;">
            <p>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.</p>
            <button id="retryButton" class="btn">ë‹¤ì‹œ ì‹œë„</button>
        </div>
        
        <table id="userTable">
            <thead>
                <tr>
                    <th data-sort="rank">ìˆœìœ„</th>
                    <th data-sort="userId">ìœ ì €ëª…</th>
                    <th data-sort="gameDays">í”Œë ˆì´ ì¼ìˆ˜</th>
                    <th data-sort="totalNetBet">ì´ ìœ íš¨ë°°íŒ…</th>
                    <th data-sort="lastGameDate">ë§ˆì§€ë§‰ í”Œë ˆì´</th>
                    <th data-sort="daysSinceLastGame">ê²½ê³¼ì¼ìˆ˜</th>
                    <th data-sort="status">ìƒíƒœ</th>
                </tr>
            </thead>
            <tbody id="userTableBody">
                <!-- ë°ì´í„°ê°€ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ë¡œë“œë©ë‹ˆë‹¤ -->
            </tbody>
        </table>
        
        <div class="pagination-container">
            <div class="pagination-info">
                <span id="paginationInfo">ì´ 0ëª…ì˜ ì‚¬ìš©ì ì¤‘ 0-0ëª… í‘œì‹œ</span>
            </div>
            <div class="pagination-controls">
                <button id="firstPage" class="pagination-btn" disabled>&laquo;</button>
                <button id="prevPage" class="pagination-btn" disabled>&lsaquo;</button>
                <div id="pageNumbers" class="page-numbers">
                    <!-- í˜ì´ì§€ ë²ˆí˜¸ê°€ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ë¡œë“œë©ë‹ˆë‹¤ -->
                </div>
                <button id="nextPage" class="pagination-btn" disabled>&rsaquo;</button>
                <button id="lastPage" class="pagination-btn" disabled>&raquo;</button>
            </div>
            <div class="page-size-selector">
                <label for="pageSize">í˜ì´ì§€ë‹¹ í•­ëª©:</label>
                <select id="pageSize">
                    <option value="10">10</option>
                    <option value="20" selected>20</option>
                    <option value="50">50</option>
                    <option value="100">100</option>
                </select>
            </div>
        </div>
    </div>
    
    <!-- ê¶Œì¥ ì „ëµ ì„¹ì…˜ -->
    <div class="section">
        <h2>ê¶Œì¥ ì „ëµ</h2>
        
        <div class="recommendations">
            <h3>í™œì„± ê³ ê°€ì¹˜ ì‚¬ìš©ì ìœ ì§€ ì „ëµ</h3>
            <ul>
                <li><strong>ë§ì¶¤í˜• VIP í”„ë¡œê·¸ë¨</strong>: ê°œì¸í™”ëœ ë³´ìƒ ë° í˜œíƒ, ì „ë‹´ VIP ë§¤ë‹ˆì € ë°°ì •</li>
                <li><strong>ê³„ì¸µì  ì¶©ì„±ë„ í”„ë¡œê·¸ë¨</strong>: í™œë™ ìˆ˜ì¤€ì— ë”°ë¥¸ ë“±ê¸‰ ì‹œìŠ¤í…œ, ë“±ê¸‰ë³„ ì°¨ë³„í™”ëœ í˜œíƒ</li>
                <li><strong>í™œë™ ì˜ˆì¸¡ ë° ì˜ˆë°©</strong>: í™œë™ íŒ¨í„´ ëª¨ë‹ˆí„°ë§, í™œë™ ê°ì†Œ ì‹œ ì¦‰ê°ì ì¸ ê°œì…</li>
            </ul>
        </div>
        
        <div class="recommendations">
            <h3>íœ´ë©´ ê³ ê°€ì¹˜ ì‚¬ìš©ì ì¬í™œì„±í™” ì „ëµ</h3>
            <ul>
                <li><strong>ì„¸ê·¸ë¨¼íŠ¸ë³„ ë§ì¶¤í˜• ì „ëµ</strong>:
                    <ul>
                        <li>ë‹¨ê¸° íœ´ë©´(31-90ì¼): ì¦‰ê°ì ì¸ ë³µê·€ ì¸ì„¼í‹°ë¸Œ, í™˜ì˜ ë³´ë„ˆìŠ¤</li>
                        <li>ì¤‘ê¸° íœ´ë©´(91-365ì¼): ë‹¨ê³„ì  ì¬ì°¸ì—¬ ìœ ë„, ë” í° ë³´ìƒ</li>
                        <li>ì¥ê¸° íœ´ë©´(365ì¼+): ê°•ë ¥í•œ ë³µê·€ íŒ¨í‚¤ì§€, ìµœì‹  ê¸°ëŠ¥ ì†Œê°œ</li>
                    </ul>
                </li>
            </ul>
        </div>
    </div>
    
    <footer>
        <p>Â© 2025 DB2 í”„ë¡œì íŠ¸ íŒ€ | ë³´ê³ ì„œ ìƒì„±ì¼: 2025-05-21</p>
        <p><a href="/">í™ˆí˜ì´ì§€ë¡œ ëŒì•„ê°€ê¸°</a></p>
    </footer>
    
    <!-- API í˜¸ì¶œ ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ (Task #26 - API ê²½ë¡œ í‘œì¤€í™” ë° ì‘ë‹µ ì²˜ë¦¬ ê°œì„ ) -->
    <script>
// ì „ì—­ ë³€ìˆ˜ ì„ ì–¸ (í˜ì´ì§€ ìƒíƒœ ê´€ë¦¬)
window.currentPage = 1;
window.pageSize = 20;
window.totalPages = 1;
window.totalUsers = 0;
window.userData = [];
window.sortField = 'netBet';
window.sortOrder = 'desc';

// API ê²½ë¡œ êµ¬ì„±
const API_CONFIG = {
  // API ë²„ì „
  version: 'v1',
  
  // ë² ì´ìŠ¤ URL (Firebase Functions ì—ë®¬ë ˆì´í„°)
  baseUrl: 'http://127.0.0.1:9000/db888-67827/us-central1',
  
  // ì—”ë“œí¬ì¸íŠ¸
  endpoints: {
    active: '/highValueUsersApi/active',
    dormant: '/highValueUsersApi/dormant',
    export: '/highValueUsersApi/export/csv'
  },
  
  // ë ˆê±°ì‹œ í˜¸í™˜ì„± (V1 ê¸°ë°˜ API ì‘ë‹µ ì™„ë£Œ ì „ê¹Œì§€ ì‚¬ìš©)
  legacy: {
    baseUrl: 'http://127.0.0.1:9000/db888-67827/us-central1/highValueUsersApi',
    forceUseLegacy: true  // Firebase Functions í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•´ trueë¡œ ì„¤ì •
  }
};

// API í˜¸ì¶œ í•¨ìˆ˜
async function fetchApiData(endpoint, params = {}) {
  // í˜„ì¬ API ì„ íƒ (ë ˆê±°ì‹œ ë˜ëŠ” V1)
  const baseUrl = API_CONFIG.legacy.forceUseLegacy 
    ? API_CONFIG.legacy.baseUrl
    : API_CONFIG.baseUrl;
    
  // URL êµ¬ì„±
  const queryParams = new URLSearchParams(params);
  const url = `${baseUrl}${endpoint}?${queryParams.toString()}`;
  
  console.log('API í˜¸ì¶œ:', url);
  
  try {
    // API í˜¸ì¶œ
    const response = await fetch(url);
    
    if (!response.ok) {
      throw new Error(`API ì˜¤ë¥˜: ${response.status} ${response.statusText}`);
    }
    
    const data = await response.json();
    
    // ì‘ë‹µ êµ¬ì¡° ì •ê·œí™” (ë ˆê±°ì‹œ APIì™€ V1 API ì‘ë‹µ í¬ë§· ì°¨ì´ ì²˜ë¦¬)
    return normalizeApiResponse(data, endpoint);
    
  } catch (error) {
    console.error('API í˜¸ì¶œ ì˜¤ë¥˜:', error);
    
    // ì˜¤ë¥˜ ì‹œ ë ˆê±°ì‹œ API í´ë°± ì‹œë„
    if (!API_CONFIG.legacy.forceUseLegacy) {
      console.log('ë ˆê±°ì‹œ APIë¡œ í´ë°± ì‹œë„...');
      API_CONFIG.legacy.forceUseLegacy = true;
      return fetchApiData(endpoint, params);
    }
    
    throw error;
  }
}

// API ì‘ë‹µ êµ¬ì¡° ì •ê·œí™” (ì–‘ìª½ API í¬ë§· ì°¨ì´ ì²˜ë¦¬)
function normalizeApiResponse(data, endpoint) {
  // API ë²„ì „ ê°ì§€
  const isLegacyResponse = !data.metadata && data.data;
  const isV1Response = !!data.metadata;
  
  if (isV1Response) {
    // ì´ë¯¸ V1 API ì‘ë‹µ í˜•ì‹ì¸ ê²½ìš° ê·¸ëŒ€ë¡œ ë°˜í™˜
    return {
      data: data.data || [],
      totalCount: data.metadata.pagination.totalCount,
      currentPage: data.metadata.pagination.currentPage,
      pageSize: data.metadata.pagination.pageSize,
      totalPages: data.metadata.pagination.totalPages,
      success: data.success
    };
  } else if (isLegacyResponse) {
    // ë ˆê±°ì‹œ API ì‘ë‹µ í˜•ì‹ì„ V1 í˜•ì‹ìœ¼ë¡œ ë³€í™˜
    return {
      data: data.data || [],
      totalCount: data.totalCount || 0,
      currentPage: data.currentPage || 1,
      pageSize: data.params?.limit || 20,
      totalPages: data.pages || 1,
      success: data.success
    };
  } else {
    // ì•Œ ìˆ˜ ì—†ëŠ” ì‘ë‹µ í˜•ì‹
    console.warn('ì•Œ ìˆ˜ ì—†ëŠ” API ì‘ë‹µ í˜•ì‹:', data);
    return {
      data: [],
      totalCount: 0,
      currentPage: 1,
      pageSize: 20,
      totalPages: 1,
      success: false
    };
  }
}

// CSV ë‚´ë³´ë‚´ê¸° URL ìƒì„±
function generateCsvExportUrl(params = {}) {
  const baseUrl = API_CONFIG.legacy.forceUseLegacy 
    ? API_CONFIG.legacy.baseUrl
    : API_CONFIG.baseUrl;
    
  const queryParams = new URLSearchParams(params);
  return `${baseUrl}${API_CONFIG.endpoints.export}?${queryParams.toString()}`;
}

// í˜ì´ì§€ ë¡œë”© ì‹œ ì‚¬ìš©ì ë°ì´í„° ë¡œë“œ
async function loadUserData() {
  // UI ìƒíƒœ ì—…ë°ì´íŠ¸
  updateLoadingState(true);
  
  try {
    // í•„í„° ì˜µì…˜ ê°€ì ¸ì˜¤ê¸°
    const statusFilter = document.getElementById('userStatus').value;
    const minBettingValue = parseInt(document.getElementById('minBetting').value, 10);
    const searchTerm = document.getElementById('userSearch').value.trim();
    
    // ì •ë ¬ ë° í˜ì´ì§€ë„¤ì´ì…˜ ì˜µì…˜ (ì „ì—­ ë³€ìˆ˜ ì§ì ‘ ì°¸ì¡°)
    const sortParams = { 
      sortBy: window.sortField || 'netBet', 
      sortOrder: window.sortOrder || 'desc' 
    };
    const paginationParams = { 
      page: window.currentPage || 1, 
      limit: window.pageSize || 20 
    };
    
    // API ê²½ë¡œ ì„ íƒ
    let endpoint = '';
    let params = {
      ...paginationParams,
      ...sortParams,
      minNetBet: minBettingValue
    };
    
    if (statusFilter === 'dormant') {
      endpoint = '/dormant';
    } else if (statusFilter === 'all') {
      // 'all' ì˜µì…˜ì€ í˜„ì¬ active APIë¡œ ì²˜ë¦¬ (ì¶”í›„ í†µí•© API ê°œë°œ ì‹œ ë³€ê²½)
      endpoint = '';
    }
    
    // ê²€ìƒ‰ì–´ ì¶”ê°€
    if (searchTerm) {
      params.search = searchTerm;
    }
    
    // API í˜¸ì¶œ
    const result = await fetchApiData(endpoint, params);
    
    if (result.success) {
      // ë°ì´í„° ì—…ë°ì´íŠ¸
      window.userData = result.data || [];
      window.totalUsers = result.totalCount || 0;
      window.totalPages = result.totalPages || 1;
      
      // UI ì—…ë°ì´íŠ¸
      if (typeof updateTable === 'function') {
        updateTable();
      }
      if (typeof updatePagination === 'function') {
        updatePagination();
      }
      
      // ë¡œë”© ìƒíƒœ ì—…ë°ì´íŠ¸
      updateLoadingState(false);
    } else {
      // ì˜¤ë¥˜ ì²˜ë¦¬
      throw new Error('API ì‘ë‹µ ì˜¤ë¥˜');
    }
  } catch (error) {
    console.error('ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', error);
    
    // ì˜¤ë¥˜ ë©”ì‹œì§€ í‘œì‹œ
    updateLoadingState(false, true);
  }
}

// CSV ë‚´ë³´ë‚´ê¸° í•¨ìˆ˜
function exportUserDataToCsv() {
  // í•„í„° ì˜µì…˜ ê°€ì ¸ì˜¤ê¸°
  const statusFilter = document.getElementById('userStatus').value;
  const minBettingValue = parseInt(document.getElementById('minBetting').value, 10);
  const searchTerm = document.getElementById('userSearch').value.trim();
  
  // ì—‘ìŠ¤í¬íŠ¸ URL ìƒì„±
  const params = {
    minNetBet: minBettingValue
  };
  
  // ìœ ì € íƒ€ì… ì¶”ê°€
  if (statusFilter !== 'all') {
    params.type = statusFilter;
  }
  
  // ê²€ìƒ‰ì–´ ì¶”ê°€
  if (searchTerm) {
    params.search = searchTerm;
  }
  
  // CSV ë‚´ë³´ë‚´ê¸° URL ìƒì„±
  const exportUrl = generateCsvExportUrl(params);
  
  // ìƒˆ íƒ­ì—ì„œ URL ì—´ê¸° (ë‹¤ìš´ë¡œë“œ íŠ¸ë¦¬ê±°)
  window.open(exportUrl, '_blank');
}

// UI ìƒíƒœ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
function updateLoadingState(isLoading, hasError = false) {
  const loadingIndicator = document.getElementById('loadingIndicator');
  const errorMessage = document.getElementById('errorMessage');
  const userTable = document.getElementById('userTable');
  
  if (isLoading) {
    // ë¡œë”© ìƒíƒœ í‘œì‹œ
    loadingIndicator.style.display = 'flex';
    errorMessage.style.display = 'none';
    userTable.style.display = 'none';
  } else if (hasError) {
    // ì˜¤ë¥˜ ìƒíƒœ í‘œì‹œ
    loadingIndicator.style.display = 'none';
    errorMessage.style.display = 'block';
    userTable.style.display = 'none';
  } else {
    // ì •ìƒ ìƒíƒœ í‘œì‹œ
    loadingIndicator.style.display = 'none';
    errorMessage.style.display = 'none';
    userTable.style.display = 'table';
  }
}

// í…Œì´ë¸” ì—…ë°ì´íŠ¸ í•¨ìˆ˜
function updateTable() {
  const userTableBody = document.getElementById('userTableBody');
  
  userTableBody.innerHTML = '';
  
  if (window.userData.length === 0) {
    const emptyRow = document.createElement('tr');
    emptyRow.innerHTML = `<td colspan="7" style="text-align: center;">ì¡°ê±´ì— ë§ëŠ” ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤.</td>`;
    userTableBody.appendChild(emptyRow);
    return;
  }
  
  window.userData.forEach((user, index) => {
    const row = document.createElement('tr');
    const rank = (window.currentPage - 1) * window.pageSize + index + 1;
    
    // í”Œë ˆì´ ì¼ì í¬ë§·íŒ…
    let lastActivity = '-';
    if (user.lastActivity) {
      lastActivity = user.lastActivity;
    }
    
    // ìƒíƒœ ê²°ì •
    const status = user.status || (user.inactiveDays <= 30 ? 'active' : 'dormant');
    const statusLabel = status === 'active' ? 'í™œì„±' : 'íœ´ë©´';
    
    row.innerHTML = `
      <td>${rank}</td>
      <td>${user.userName || user.userId || 'ì•Œ ìˆ˜ ì—†ìŒ'}</td>
      <td>${user.playDays || user.loginCount || 0}</td>
      <td>${(user.netBet || 0).toLocaleString()}</td>
      <td>${lastActivity}</td>
      <td>${user.inactiveDays || 0}</td>
      <td><span class="tag tag-${status}">${statusLabel}</span></td>
    `;
    
    userTableBody.appendChild(row);
  });
}

// í˜ì´ì§€ë„¤ì´ì…˜ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
function updatePagination() {
  const paginationInfo = document.getElementById('paginationInfo');
  const firstPageBtn = document.getElementById('firstPage');
  const prevPageBtn = document.getElementById('prevPage');
  const nextPageBtn = document.getElementById('nextPage');
  const lastPageBtn = document.getElementById('lastPage');
  const pageNumbers = document.getElementById('pageNumbers');
  
  // í˜ì´ì§€ ì •ë³´ ì—…ë°ì´íŠ¸
  const start = (window.currentPage - 1) * window.pageSize + 1;
  const end = Math.min(window.currentPage * window.pageSize, window.totalUsers);
  paginationInfo.textContent = `ì´ ${window.totalUsers}ëª…ì˜ ì‚¬ìš©ì ì¤‘ ${start}-${end}ëª… í‘œì‹œ`;
  
  // í˜ì´ì§€ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
  firstPageBtn.disabled = window.currentPage === 1;
  prevPageBtn.disabled = window.currentPage === 1;
  nextPageBtn.disabled = window.currentPage === window.totalPages;
  lastPageBtn.disabled = window.currentPage === window.totalPages;
  
  // í˜ì´ì§€ ë²ˆí˜¸ ìƒì„±
  pageNumbers.innerHTML = '';
  
  const maxPageNumbers = 5;
  const pageRange = getPageRange(window.currentPage, window.totalPages, maxPageNumbers);
  
  for (let i = pageRange.start; i <= pageRange.end; i++) {
    const pageBtn = document.createElement('button');
    pageBtn.textContent = i;
    pageBtn.className = 'pagination-btn' + (i === window.currentPage ? ' active' : '');
    
    pageBtn.addEventListener('click', function() {
      if (window.currentPage !== i) {
        window.currentPage = i;
        loadUserData();
      }
    });
    
    pageNumbers.appendChild(pageBtn);
  }
}

// í˜ì´ì§€ ë²”ìœ„ ê³„ì‚° í•¨ìˆ˜
function getPageRange(current, total, max) {
  let start = Math.max(1, current - Math.floor(max / 2));
  let end = start + max - 1;
  
  if (end > total) {
    end = total;
    start = Math.max(1, end - max + 1);
  }
  
  return { start, end };
}

// í…Œì´ë¸” ì—´ ì´ë¦„ì„ API íŒŒë¼ë¯¸í„°ë¡œ ë³€í™˜
function getColumnName(headerText) {
  const mapping = {
    'ìœ ì €ëª…': 'userName',
    'í”Œë ˆì´ ì¼ìˆ˜': 'playDays',
    'ì´ ìœ íš¨ë°°íŒ…': 'netBet',
    'ë§ˆì§€ë§‰ í”Œë ˆì´': 'lastActivity',
    'ê²½ê³¼ì¼ìˆ˜': 'inactiveDays'
  };
  
  return mapping[headerText];
}
    </script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // DOM ìš”ì†Œ ì°¸ì¡° ë³€ìˆ˜
            const userTableBody = document.getElementById('userTableBody');
            const loadingIndicator = document.getElementById('loadingIndicator');
            const errorMessage = document.getElementById('errorMessage');
            const retryButton = document.getElementById('retryButton');
            
            const userStatus = document.getElementById('userStatus');
            const minBetting = document.getElementById('minBetting');
            const userSearch = document.getElementById('userSearch');
            const applyFilters = document.getElementById('applyFilters');
            const exportCsv = document.getElementById('exportCsv');
            
            const firstPageBtn = document.getElementById('firstPage');
            const prevPageBtn = document.getElementById('prevPage');
            const nextPageBtn = document.getElementById('nextPage');
            const lastPageBtn = document.getElementById('lastPage');
            const pageNumbers = document.getElementById('pageNumbers');
            const pageSizeSelect = document.getElementById('pageSize');
            const paginationInfo = document.getElementById('paginationInfo');
            
            // í˜ì´ì§€ í¬ê¸° ì´ˆê¸°í™”
            window.pageSize = parseInt(pageSizeSelect.value, 10);
            
            // ì´ˆê¸° ë°ì´í„° ë¡œë“œ
            loadUserData();
            
            // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
            applyFilters.addEventListener('click', function() {
                window.currentPage = 1;
                loadUserData();
            });
            
            retryButton.addEventListener('click', loadUserData);
            
            // CSV ë‚´ë³´ë‚´ê¸° ë²„íŠ¼
            exportCsv.addEventListener('click', function() {
                exportUserDataToCsv();
            });
            
            pageSizeSelect.addEventListener('change', function() {
                window.pageSize = parseInt(this.value, 10);
                window.currentPage = 1;
                loadUserData();
            });
            
            firstPageBtn.addEventListener('click', function() {
                if (window.currentPage !== 1) {
                    window.currentPage = 1;
                    loadUserData();
                }
            });
            
            prevPageBtn.addEventListener('click', function() {
                if (window.currentPage > 1) {
                    window.currentPage--;
                    loadUserData();
                }
            });
            
            nextPageBtn.addEventListener('click', function() {
                if (window.currentPage < window.totalPages) {
                    window.currentPage++;
                    loadUserData();
                }
            });
            
            lastPageBtn.addEventListener('click', function() {
                if (window.currentPage !== window.totalPages) {
                    window.currentPage = window.totalPages;
                    loadUserData();
                }
            });
            
            // í…Œì´ë¸” í—¤ë”ì— ì •ë ¬ ê¸°ëŠ¥ ì¶”ê°€
            document.querySelectorAll('#userTable th').forEach(header => {
                header.addEventListener('click', function() {
                    const columnName = getColumnName(this.textContent);
                    
                    if (columnName) {
                        if (window.sortField === columnName) {
                            window.sortOrder = window.sortOrder === 'asc' ? 'desc' : 'asc';
                        } else {
                            window.sortField = columnName;
                            window.sortOrder = 'desc';
                        }
                        
                        window.currentPage = 1;
                        loadUserData();
                    }
                });
            });
            
            // í…Œì´ë¸” ì—´ ì´ë¦„ì„ API íŒŒë¼ë¯¸í„°ë¡œ ë³€í™˜
            function getColumnName(headerText) {
                const mapping = {
                    'ìœ ì €ëª…': 'userName',
                    'í”Œë ˆì´ ì¼ìˆ˜': 'playDays',
                    'ì´ ìœ íš¨ë°°íŒ…': 'netBet',
                    'ë§ˆì§€ë§‰ í”Œë ˆì´': 'lastActivity',
                    'ê²½ê³¼ì¼ìˆ˜': 'inactiveDays'
                };
                
                return mapping[headerText];
            }
            
            // í…Œì´ë¸” ì—…ë°ì´íŠ¸
            function updateTable() {
                userTableBody.innerHTML = '';
                
                if (window.userData.length === 0) {
                    const emptyRow = document.createElement('tr');
                    emptyRow.innerHTML = `<td colspan="7" style="text-align: center;">ì¡°ê±´ì— ë§ëŠ” ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤.</td>`;
                    userTableBody.appendChild(emptyRow);
                    return;
                }
                
                window.userData.forEach((user, index) => {
                    const row = document.createElement('tr');
                    const rank = (window.currentPage - 1) * window.pageSize + index + 1;
                    
                    // í”Œë ˆì´ ì¼ì í¬ë§·íŒ…
                    let lastActivity = '-';
                    if (user.lastActivity) {
                        lastActivity = user.lastActivity;
                    }
                    
                    // ìƒíƒœ ê²°ì •
                    const status = user.status || (user.inactiveDays <= 30 ? 'active' : 'dormant');
                    const statusLabel = status === 'active' ? 'í™œì„±' : 'íœ´ë©´';
                    
                    row.innerHTML = `
                        <td>${rank}</td>
                        <td>${user.userName || user.userId || 'ì•Œ ìˆ˜ ì—†ìŒ'}</td>
                        <td>${user.playDays || user.loginCount || 0}</td>
                        <td>${(user.netBet || 0).toLocaleString()}</td>
                        <td>${lastActivity}</td>
                        <td>${user.inactiveDays || 0}</td>
                        <td><span class="tag tag-${status}">${statusLabel}</span></td>
                    `;
                    
                    userTableBody.appendChild(row);
                });
            }
            
            // í˜ì´ì§€ë„¤ì´ì…˜ ì—…ë°ì´íŠ¸
            function updatePagination() {
                // í˜ì´ì§€ ì •ë³´ ì—…ë°ì´íŠ¸
                const start = (window.currentPage - 1) * window.pageSize + 1;
                const end = Math.min(window.currentPage * window.pageSize, window.totalUsers);
                paginationInfo.textContent = `ì´ ${window.totalUsers}ëª…ì˜ ì‚¬ìš©ì ì¤‘ ${start}-${end}ëª… í‘œì‹œ`;
                
                // í˜ì´ì§€ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
                firstPageBtn.disabled = window.currentPage === 1;
                prevPageBtn.disabled = window.currentPage === 1;
                nextPageBtn.disabled = window.currentPage === window.totalPages;
                lastPageBtn.disabled = window.currentPage === window.totalPages;
                
                // í˜ì´ì§€ ë²ˆí˜¸ ìƒì„±
                pageNumbers.innerHTML = '';
                
                const maxPageNumbers = 5;
                const pageRange = getPageRange(window.currentPage, window.totalPages, maxPageNumbers);
                
                for (let i = pageRange.start; i <= pageRange.end; i++) {
                    const pageBtn = document.createElement('button');
                    pageBtn.textContent = i;
                    pageBtn.className = 'pagination-btn' + (i === window.currentPage ? ' active' : '');
                    
                    pageBtn.addEventListener('click', function() {
                        if (window.currentPage !== i) {
                            window.currentPage = i;
                            loadUserData();
                        }
                    });
                    
                    pageNumbers.appendChild(pageBtn);
                }
            }
            
            // í˜ì´ì§€ ë²”ìœ„ ê³„ì‚°
            function getPageRange(current, total, max) {
                let start = Math.max(1, current - Math.floor(max / 2));
                let end = start + max - 1;
                
                if (end > total) {
                    end = total;
                    start = Math.max(1, end - max + 1);
                }
                
                return { start, end };
            }
        
            // UI ìƒíƒœ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
            function updateLoadingState(isLoading, hasError = false) {
                if (isLoading) {
                    // ë¡œë”© ìƒíƒœ í‘œì‹œ
                    loadingIndicator.style.display = 'flex';
                    errorMessage.style.display = 'none';
                    userTable.style.display = 'none';
                } else if (hasError) {
                    // ì˜¤ë¥˜ ìƒíƒœ í‘œì‹œ
                    loadingIndicator.style.display = 'none';
                    errorMessage.style.display = 'block';
                    userTable.style.display = 'none';
                } else {
                    // ì •ìƒ ìƒíƒœ í‘œì‹œ
                    loadingIndicator.style.display = 'none';
                    errorMessage.style.display = 'none';
                    userTable.style.display = 'table';
                }
            }
        });
    </script>
</body>
</html>